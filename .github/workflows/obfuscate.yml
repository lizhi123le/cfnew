name: æ··æ·†å¹¶åˆ›å»º GitHub å‘è¡Œç‰ˆ
on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 */9 * * *'

jobs:
  obfuscate-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      # ==================== æ£€æŸ¥ä¸Šæ¸¸æ›´æ–° ====================
      - name: æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ›´æ–°å¹¶æ‰§è¡Œæ­£ç¡®çš„ä¸‰æ–¹åˆå¹¶
        id: check-update
        run: |
          set -euo pipefail
          
          # æ–‡ä»¶è·¯å¾„å®šä¹‰
          WORKER_URL="https://raw.githubusercontent.com/byJoey/cfnew/refs/heads/main/æ˜æ–‡æºå—"
          MD_URL="https://raw.githubusercontent.com/byJoey/cfnew/refs/heads/main/README.md"
          
          WORKING_FILE="æ˜æ–‡æºå—"           # å½“å‰å·¥ä½œæ–‡ä»¶
          BACKUP_FILE="æ˜æ–‡æºå—.local"      # æœ¬åœ°ä¿®æ”¹å¤‡ä»½
          BASE_FILE="æ˜æ–‡æºå—.base"         # ä¸Šæ¬¡ä¸Šæ¸¸ç‰ˆæœ¬ï¼ˆåŸºçº¿ï¼‰
          UPSTREAM_FILE="æ˜æ–‡æºå—.upstream" # æ–°çš„ä¸Šæ¸¸ç‰ˆæœ¬
          MD_FILE="README.md"
          
          # å“ˆå¸Œæ–‡ä»¶
          WORKER_HASH_FILE=".worker_hash"
          MD_HASH_FILE=".md_hash"
          
          # çŠ¶æ€æ–‡ä»¶
          MERGE_STATE_FILE=".merge_state"
          CONFLICT_FILE="merge_conflict.md"
          
          echo "=== å¼€å§‹ä¸Šæ¸¸æ›´æ–°æ£€æŸ¥ ==="
          
          # ä¸‹è½½ä¸Šæ¸¸æ–‡ä»¶
          curl -fsSL -o "$UPSTREAM_FILE" "$WORKER_URL"
          curl -fsSL -o temp_md.md "$MD_URL"
          
          # éªŒè¯ä¸‹è½½æˆåŠŸ
          if [ ! -f "$UPSTREAM_FILE" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•ä¸‹è½½ä¸Šæ¸¸å·¥ä½œæ–‡ä»¶"
            exit 1
          fi
          
          # è®¡ç®—å“ˆå¸Œå€¼
          NEW_WORKER_HASH=$(sha256sum "$UPSTREAM_FILE" | cut -d' ' -f1)
          NEW_MD_HASH=$(sha256sum temp_md.md | cut -d' ' -f1)
          OLD_WORKER_HASH=$(cat "$WORKER_HASH_FILE" 2>/dev/null || echo "")
          OLD_MD_HASH=$(cat "$MD_HASH_FILE" 2>/dev/null || echo "")
          
          echo "ä¸Šæ¸¸å·¥ä½œæ–‡ä»¶å“ˆå¸Œ: $NEW_WORKER_HASH"
          echo "æœ¬åœ°å·¥ä½œæ–‡ä»¶å“ˆå¸Œ: $OLD_WORKER_HASH"
          echo "ä¸Šæ¸¸READMEå“ˆå¸Œ: $NEW_MD_HASH"
          echo "æœ¬åœ°READMEå“ˆå¸Œ: $OLD_MD_HASH"
          
          HAS_UPDATE="false"
          MERGE_STATUS="none"
          
          # ==================== å¤„ç†å·¥ä½œæ–‡ä»¶çš„ä¸‰æ–¹åˆå¹¶ ====================
          if [ "$NEW_WORKER_HASH" != "$OLD_WORKER_HASH" ]; then
            echo "æ£€æµ‹åˆ°ä¸Šæ¸¸å·¥ä½œæ–‡ä»¶æ›´æ–°ï¼Œå¼€å§‹åˆå¹¶æµç¨‹..."
            HAS_UPDATE="true"
            
            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            if [ ! -s "$UPSTREAM_FILE" ]; then
              echo "é”™è¯¯ï¼šä¸Šæ¸¸æ–‡ä»¶ä¸ºç©º"
              exit 1
            fi
            
            # åˆå§‹åŒ–æˆ–éªŒè¯åˆå¹¶çŠ¶æ€
            if [ ! -f "$MERGE_STATE_FILE" ]; then
              echo "é¦–æ¬¡è¿è¡Œï¼Œåˆå§‹åŒ–åˆå¹¶çŠ¶æ€"
              echo "initialized=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > "$MERGE_STATE_FILE"
              
              # åˆå§‹åŒ–åŸºçº¿æ–‡ä»¶
              if [ ! -f "$BASE_FILE" ]; then
                echo "åˆ›å»ºåŸºçº¿æ–‡ä»¶"
                cp "$UPSTREAM_FILE" "$BASE_FILE"
              fi
              
              # å¤„ç†æœ¬åœ°ä¿®æ”¹
              if [ -f "$WORKING_FILE" ]; then
                if ! cmp -s "$WORKING_FILE" "$BASE_FILE" 2>/dev/null; then
                  echo "æ£€æµ‹åˆ°æœ¬åœ°ä¿®æ”¹ï¼Œåˆ›å»ºå¤‡ä»½"
                  cp "$WORKING_FILE" "$BACKUP_FILE"
                  echo "has_local_changes=true" >> "$MERGE_STATE_FILE"
                else
                  echo "æ— æœ¬åœ°ä¿®æ”¹"
                  echo "has_local_changes=false" >> "$MERGE_STATE_FILE"
                fi
              else
                echo "å·¥ä½œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬"
                cp "$UPSTREAM_FILE" "$WORKING_FILE"
                echo "has_local_changes=false" >> "$MERGE_STATE_FILE"
              fi
            else
              echo "å·²åˆå§‹åŒ–çŠ¶æ€ï¼Œç»§ç»­åˆå¹¶æµç¨‹"
            fi
            
            # è¯»å–åˆå¹¶çŠ¶æ€
            HAS_LOCAL_CHANGES=$(grep "has_local_changes=" "$MERGE_STATE_FILE" | cut -d'=' -f2 || echo "false")
            echo "æœ¬åœ°ä¿®æ”¹çŠ¶æ€: $HAS_LOCAL_CHANGES"
            
            # æ‰§è¡Œä¸‰æ–¹åˆå¹¶
            if [ "$HAS_LOCAL_CHANGES" = "true" ] && [ -f "$BACKUP_FILE" ] && [ -f "$BASE_FILE" ]; then
              echo "=== æ‰§è¡Œä¸‰æ–¹åˆå¹¶ ==="
              echo "æœ¬åœ°ç‰ˆæœ¬: $BACKUP_FILE"
              echo "åŸºçº¿ç‰ˆæœ¬: $BASE_FILE"
              echo "ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM_FILE"
              
              # åˆ›å»ºåˆå¹¶ä¸´æ—¶æ–‡ä»¶
              MERGE_RESULT="$WORKING_FILE.merge"
              
              # æ‰§è¡Œgitä¸‰æ–¹åˆå¹¶
              if git merge-file "$BACKUP_FILE" "$BASE_FILE" "$UPSTREAM_FILE" > /dev/null 2>&1; then
                echo "âœ… ä¸‰æ–¹åˆå¹¶æˆåŠŸ"
                
                # éªŒè¯åˆå¹¶ç»“æœ
                if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then
                  cp "$BACKUP_FILE" "$WORKING_FILE"
                  MERGE_STATUS="success"
                  echo "åˆå¹¶çŠ¶æ€: æˆåŠŸ"
                  
                  # æ›´æ–°åŸºçº¿æ–‡ä»¶ä¸ºæ–°çš„ä¸Šæ¸¸ç‰ˆæœ¬
                  cp "$UPSTREAM_FILE" "$BASE_FILE"
                  
                  # æ¸…ç†æœ¬åœ°å¤‡ä»½ï¼ˆå·²åˆå¹¶åˆ°å·¥ä½œæ–‡ä»¶ï¼‰
                  rm -f "$BACKUP_FILE"
                  echo "has_local_changes=false" > "$MERGE_STATE_FILE"
                  
                else
                  echo "âŒ åˆå¹¶ç»“æœéªŒè¯å¤±è´¥"
                  MERGE_STATUS="failed"
                fi
              else
                echo "âš ï¸ ä¸‰æ–¹åˆå¹¶å­˜åœ¨å†²çª"
                MERGE_STATUS="conflict"
                
                # ä¿ç•™å†²çªæ–‡ä»¶ä¾›æ‰‹åŠ¨å¤„ç†
                cp "$BACKUP_FILE" "$WORKING_FILE.conflict"
                
                # åˆ›å»ºå†²çªæŠ¥å‘Š
                cat > "$CONFLICT_FILE" << EOF
          # åˆå¹¶å†²çªæŠ¥å‘Š
          
          ## å†²çªæ—¶é—´
          $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          ## ä¸Šæ¸¸æ›´æ–°å“ˆå¸Œ
          $NEW_WORKER_HASH
          
          ## å†²çªè¯´æ˜
          ä¸‰æ–¹åˆå¹¶è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚
          
          ## æ–‡ä»¶çŠ¶æ€
          - å·¥ä½œæ–‡ä»¶: $WORKING_FILE
          - å†²çªæ–‡ä»¶: $WORKING_FILE.conflict
          - æœ¬åœ°å¤‡ä»½: $BACKUP_FILE
          - åŸºçº¿ç‰ˆæœ¬: $BASE_FILE
          - ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM_FILE
          
          ## è§£å†³æ­¥éª¤
          1. æ£€æŸ¥å†²çªæ–‡ä»¶ä¸­çš„å†²çªæ ‡è®° (<<<<<<<, =======, >>>>>>>)
          2. æ‰‹åŠ¨ç¼–è¾‘å†²çªæ–‡ä»¶ï¼Œä¿ç•™éœ€è¦çš„ä¿®æ”¹
          3. è§£å†³å†²çªåï¼Œå°†ç»“æœå¤åˆ¶åˆ°å·¥ä½œæ–‡ä»¶
          4. æäº¤ä¿®æ”¹å¹¶é‡æ–°è¿è¡Œå·¥ä½œæµ
          
          ## å†²çªå†…å®¹é¢„è§ˆ
          \`\`\`
          $(head -50 "$WORKING_FILE.conflict" || echo "æ–‡ä»¶è¿‡å¤§ï¼Œæ— æ³•é¢„è§ˆ")
          \`\`\`
          EOF
                
                echo "âŒ å†²çªå·²ä¿å­˜ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
                echo "å†²çªæŠ¥å‘Š: $CONFLICT_FILE"
                echo "å†²çªæ–‡ä»¶: $WORKING_FILE.conflict"
                
                # ä½œä¸ºåå¤‡æ–¹æ¡ˆï¼Œä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬ä½†ä¿ç•™æœ¬åœ°ä¿®æ”¹
                cp "$UPSTREAM_FILE" "$WORKING_FILE"
                cp "$BACKUP_FILE" "${BACKUP_FILE}.manual_merge_required"
              fi
            else
              echo "=== æ— æœ¬åœ°ä¿®æ”¹ï¼Œç›´æ¥ä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬ ==="
              cp "$UPSTREAM_FILE" "$WORKING_FILE"
              cp "$UPSTREAM_FILE" "$BASE_FILE"
              MERGE_STATUS="no_local_changes"
              
              # æ¸…ç†å¯èƒ½å­˜åœ¨çš„å¤‡ä»½
              rm -f "$BACKUP_FILE"
              echo "has_local_changes=false" > "$MERGE_STATE_FILE"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "$UPSTREAM_FILE"
            
            # æ›´æ–°å“ˆå¸Œè®°å½•
            echo "$NEW_WORKER_HASH" > "$WORKER_HASH_FILE"
            
          else
            echo "ä¸Šæ¸¸å·¥ä½œæ–‡ä»¶æ— æ›´æ–°"
            rm -f "$UPSTREAM_FILE"
          fi
          
          # ==================== å¤„ç† README.md ====================
          if [ ! -f "$MD_FILE" ] || [ "$NEW_MD_HASH" != "$OLD_MD_HASH" ]; then
            echo "README.md éœ€è¦æ›´æ–°"
            mv -f temp_md.md "$MD_FILE"
            echo "$NEW_MD_HASH" > "$MD_HASH_FILE"
            HAS_UPDATE="true"
          else
            echo "README.md æ— æ›´æ–°"
            rm -f temp_md.md
          fi
          
          # è¾“å‡ºç»“æœ
          echo "has_update=$HAS_UPDATE" >> $GITHUB_OUTPUT
          echo "merge_status=$MERGE_STATUS" >> $GITHUB_OUTPUT
          echo "worker_hash=$NEW_WORKER_HASH" >> $GITHUB_OUTPUT
          
          echo "=== æ›´æ–°æ£€æŸ¥å®Œæˆ ==="
          echo "æ˜¯å¦æœ‰æ›´æ–°: $HAS_UPDATE"
          echo "åˆå¹¶çŠ¶æ€: $MERGE_STATUS"

      # ==================== è¯»å–README.mdç‰ˆæœ¬å· ====================
      - name: è¯»å–README.mdç‰ˆæœ¬å·
        id: read-version
        run: |
          set -euo pipefail
          
          # ä»æœ¬åœ° README.md è¯»å–ç‰ˆæœ¬å·
          if [ -f "README.md" ]; then
            # å°è¯•å¤šç§å¸¸è§çš„ç‰ˆæœ¬å·æ ¼å¼
            VERSION=$(grep -E "v[0-9]+\.[0-9]+\.[0-9]+" README.md | head -1 | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" || echo "")
            
            # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–æ ¼å¼
            if [ -z "$VERSION" ]; then
              VERSION=$(grep -E "[0-9]+\.[0-9]+\.[0-9]+" README.md | head -1 | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" || echo "")
            fi
            
            # å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»æ ‡é¢˜ä¸­æå–
            if [ -z "$VERSION" ]; then
              VERSION=$(grep -E "^#+.*v[0-9]" README.md | head -1 | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" || echo "")
            fi
          fi
          
          # å¦‚æœæœ¬åœ°æ²¡æ‰¾åˆ°æˆ–æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä»ä¸Šæ¸¸è¯»å–
          if [ -z "$VERSION" ]; then
            echo "æœ¬åœ°æœªæ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œä»ä¸Šæ¸¸è¯»å–..."
            UPSTREAM_MD_URL="https://raw.githubusercontent.com/byJoey/cfnew/main/README.md"
            curl -fsSL "$UPSTREAM_MD_URL" | grep -E "v[0-9]+\.[0-9]+\.[0-9]+" | head -1 | grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" > upstream_version.txt || echo ""
            VERSION=$(cat upstream_version.txt 2>/dev/null || echo "")
            rm -f upstream_version.txt
          fi
          
          # å¦‚æœä»ç„¶æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºç‰ˆæœ¬
          if [ -z "$VERSION" ]; then
            VERSION="v$(date -u +"%Y.%m.%d")"
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºç‰ˆæœ¬: $VERSION"
          fi
          
          echo "æ£€æµ‹åˆ°çš„ç‰ˆæœ¬å·: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ==================== ä»¥ä¸‹æ­¥éª¤ä»…åœ¨éœ€è¦æ—¶æ‰§è¡Œ ====================
      - name: æ‰§è¡Œåç»­æ„å»ºï¼ˆä»…åœ¨å¿…è¦æ—¶ï¼‰
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "å¼€å§‹æ‰§è¡Œæ··æ·†ã€æäº¤ã€å‘å¸ƒæµç¨‹..."
          echo "åˆå¹¶çŠ¶æ€: ${{ steps.check-update.outputs.merge_status }}"
          
          # å¦‚æœæœ‰å†²çªï¼Œæé†’ç”¨æˆ·
          if [ "${{ steps.check-update.outputs.merge_status }}" = "conflict" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šå­˜åœ¨åˆå¹¶å†²çªï¼Œè¯·æ£€æŸ¥å†²çªæ–‡ä»¶å¹¶æ‰‹åŠ¨å¤„ç†"
            echo "å†²çªæŠ¥å‘Š: merge_conflict.md"
          fi

      - name: Set up Node.js
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Install dependencies
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          npm install
          sudo apt-get update -qq
          sudo apt-get install -y jq zip

      - name: åˆ›å»ºå·¥ä½œæ–‡ä»¶å‰¯æœ¬ç”¨äºæ··æ·†
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # éªŒè¯å·¥ä½œæ–‡ä»¶å­˜åœ¨
          if [ ! -f "æ˜æ–‡æºå—" ]; then
            echo "é”™è¯¯ï¼šå·¥ä½œæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ›å»ºå‰¯æœ¬ç”¨äºæ··æ·†
          cp "æ˜æ–‡æºå—" "æ˜æ–‡æºå—_temp"
          echo "å·¥ä½œæ–‡ä»¶å‰¯æœ¬åˆ›å»ºå®Œæˆ"

      - name: æ··æ·†ä»£ç 
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          npm run build
          
          # éªŒè¯æ··æ·†æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -f "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—" ]; then
            echo "âŒ æ··æ·†å¤±è´¥ - _worker.js æœªåˆ›å»º"
            exit 1
          else
            echo "âœ… æ··æ·†æˆåŠŸ"
            ls -la "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—"
          fi

      - name: å‹ç¼©ä¸º Pages.zip å¹¶åˆ›å»ºæ˜æ–‡å‘å¸ƒæ–‡ä»¶
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # åˆ›å»ºå‘å¸ƒæ–‡ä»¶
          cp "æ˜æ–‡æºå—" "mingwenyuanma.js"
          cp "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—" "_worker.js"
          
          # å‹ç¼©ä¸º Pages.zip
          zip Pages.zip _worker.js
          
          # éªŒè¯æ–‡ä»¶åˆ›å»º
          echo "=== å‘å¸ƒæ–‡ä»¶éªŒè¯ ==="
          ls -la Pages.zip mingwenyuanma.js _worker.js || echo "éƒ¨åˆ†æ–‡ä»¶åˆ›å»ºå¤±è´¥"
          
          if [ ! -f "Pages.zip" ]; then
            echo "âŒ å‹ç¼©åŒ…åˆ›å»ºå¤±è´¥"
            exit 1
          else
            echo "âœ… å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ"
          fi

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "=== æäº¤å‰çŠ¶æ€æ£€æŸ¥ ==="
          echo "ç›®å½•ä¸­çš„æ–‡ä»¶:"
          ls -la
          
          echo "Git çŠ¶æ€:"
          git status
          
          # åˆ†æ­¥æ·»åŠ æ–‡ä»¶
          echo "æ·»åŠ æ··æ·†æ–‡ä»¶..."
          git add "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—" || echo "è­¦å‘Šï¼šæ··æ·†æ–‡ä»¶æœªæ‰¾åˆ°"
          
          echo "æ·»åŠ å‹ç¼©åŒ…..."
          git add Pages.zip || echo "è­¦å‘Šï¼šå‹ç¼©åŒ…æœªæ‰¾åˆ°"
          
          echo "æ·»åŠ æºæ–‡ä»¶å’ŒçŠ¶æ€æ–‡ä»¶..."
          git add "æ˜æ–‡æºå—" "æ˜æ–‡æºå—.base" "æ˜æ–‡æºå—.local" "README.md" || true
          git add ".worker_hash" ".md_hash" ".merge_state" || true
          
          # æ·»åŠ å¯èƒ½çš„å†²çªç›¸å…³æ–‡ä»¶
          git add "merge_conflict.md" || true
          git add "æ˜æ–‡æºå—.conflict" || true
          git add "æ˜æ–‡æºå—.local.manual_merge_required" || true
          
          echo "æ·»åŠ åçš„ Git çŠ¶æ€:"
          git status
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # åˆ›å»ºæäº¤ä¿¡æ¯
          VERSION="${{ steps.read-version.outputs.version }}"
          MERGE_STATUS="${{ steps.check-update.outputs.merge_status }}"
          
          COMMIT_MSG="è‡ªåŠ¨æ›´æ–°ï¼šæ··æ·†ç‰ˆ + å¤‡ä»½ï¼ˆç‰ˆæœ¬ $VERSIONï¼‰"
          
          # æ ¹æ®åˆå¹¶çŠ¶æ€æ·»åŠ è¯´æ˜
          case "$MERGE_STATUS" in
            "success")
              COMMIT_MSG="$COMMIT_MSG [âœ… åˆå¹¶æˆåŠŸ]"
              ;;
            "conflict")
              COMMIT_MSG="$COMMIT_MSG [âš ï¸ å­˜åœ¨åˆå¹¶å†²çªï¼Œéœ€æ‰‹åŠ¨å¤„ç†]"
              ;;
            "no_local_changes")
              COMMIT_MSG="$COMMIT_MSG [ğŸ“¥ ä»…ä¸Šæ¸¸æ›´æ–°]"
              ;;
            "failed")
              COMMIT_MSG="$COMMIT_MSG [âŒ åˆå¹¶å¤±è´¥]"
              ;;
          esac
          
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG"
          
          echo "=== æäº¤å®Œæˆ ==="
          git log --oneline -1

      - name: Push changes
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      # ==================== åˆ›å»º/è¦†ç›– Release ====================
      - name: Create GitHub Release
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.read-version.outputs.version }}"
          MERGE_STATUS="${{ steps.check-update.outputs.merge_status }}"
          WORKER_HASH="${{ steps.check-update.outputs.worker_hash }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "=== åˆ›å»º GitHub Release ==="
          echo "ç‰ˆæœ¬ï¼š$VERSION"
          echo "åˆå¹¶çŠ¶æ€ï¼š$MERGE_STATUS"
          echo "å·¥ä½œæ–‡ä»¶å“ˆå¸Œï¼š$WORKER_HASH"
          
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„Release
          RELEASE_ID=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION" | jq -r '.id // ""')
          
          # å¦‚æœå­˜åœ¨ï¼Œåˆ é™¤æ—§çš„Release
          if [ -n "$RELEASE_ID" ] && [ "$RELEASE_ID" != "null" ]; then
            echo "åˆ é™¤æ—§ Release $RELEASE_ID"
            curl -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"
          fi
          
          # åˆ é™¤æ—§çš„æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$VERSION" | jq -e .ref >/dev/null 2>&1; then
            curl -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$VERSION"
          fi
          
          # åˆ›å»ºReleaseæè¿°
          RELEASE_BODY=$(cat << EOF
          ## éƒ¨ç½²ä¿¡æ¯
          
          - **æºæ–‡ä»¶**: å°‘å¹´ä½ ç›¸ä¿¡å…‰å—
          - **æ˜æ–‡æºæ–‡ä»¶**: æ˜æ–‡æºå—
          - **ç›®æ ‡æ–‡ä»¶**: _worker.js
          - **å‹ç¼©æ–‡ä»¶**: Pages.zip
          - **æ˜æ–‡å‘å¸ƒæ–‡ä»¶**: mingwenyuanma.js
          - **æ ‡ç­¾**: $VERSION
          - **éƒ¨ç½²æ—¶é—´**: $TIMESTAMP
          - **åˆå¹¶çŠ¶æ€**: $MERGE_STATUS
          - **æ–‡ä»¶å“ˆå¸Œ**: $WORKER_HASH
          
          ## æ–‡ä»¶å˜æ›´
          
          å·²ä» \`å°‘å¹´ä½ ç›¸ä¿¡å…‰å—\` ç”Ÿæˆ \`_worker.js\` æ–‡ä»¶ï¼Œå¹¶å‹ç¼©ä¸º \`Pages.zip\`ã€‚
          å·²ä» \`æ˜æ–‡æºå—\` å¤åˆ¶ä¸º \`mingwenyuanma.js\` ä»¥ä¾›å‘å¸ƒã€‚
          
          ## åˆå¹¶çŠ¶æ€è¯´æ˜
          
          EOF
          )
          
          # æ ¹æ®åˆå¹¶çŠ¶æ€æ·»åŠ è¯¦ç»†è¯´æ˜
          case "$MERGE_STATUS" in
            "success")
              RELEASE_BODY="$RELEASE_BODY
          âœ… **åˆå¹¶æˆåŠŸ**: æœ¬åœ°ä¿®æ”¹å·²æˆåŠŸä¸ä¸Šæ¸¸æ›´æ–°åˆå¹¶"
              ;;
            "conflict")
              RELEASE_BODY="$RELEASE_BODY
          âš ï¸ **å­˜åœ¨å†²çª**: æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
          
          å†²çªæ–‡ä»¶: \`æ˜æ–‡æºå—.conflict\`
          å†²çªæŠ¥å‘Š: \`merge_conflict.md\`
          
          è¯·æ‰‹åŠ¨è§£å†³å†²çªåé‡æ–°è¿è¡Œå·¥ä½œæµã€‚"
              ;;
            "no_local_changes")
              RELEASE_BODY="$RELEASE_BODY
          ğŸ“¥ **ä»…ä¸Šæ¸¸æ›´æ–°**: æ— æœ¬åœ°ä¿®æ”¹ï¼Œç›´æ¥åº”ç”¨ä¸Šæ¸¸æ›´æ–°"
              ;;
            "failed")
              RELEASE_BODY="$RELEASE_BODY
          âŒ **åˆå¹¶å¤±è´¥**: åˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
              ;;
          esac
          
          # åˆ›å»ºRelease
          PAYLOAD=$(jq -n --arg v "$VERSION" --arg body "$RELEASE_BODY" \
            '{tag_name: $v, name: ("Pages " + $v), body: $body, draft: false, prerelease: false}')
          
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "âŒ åˆ›å»º Release å¤±è´¥"
            echo "$RESPONSE"
            exit 1
          fi
          
          echo "âœ… Release åˆ›å»ºæˆåŠŸï¼š$VERSION (ID: $RELEASE_ID)"
          
          # ä¸Šä¼ æ–‡ä»¶
          for asset in Pages.zip mingwenyuanma.js; do
            if [ -f "$asset" ]; then
              echo "æ­£åœ¨ä¸Šä¼  $asset ..."
              UPLOAD_RESPONSE=$(curl -s -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Content-Type: $(file -b --mime-type $asset)" \
                --data-binary "@$asset" \
                "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$asset")
              
              # æ£€æŸ¥ä¸Šä¼ ç»“æœ
              ASSET_ID=$(echo "$UPLOAD_RESPONSE" | jq -r '.id // ""')
              if [ -n "$ASSET_ID" ] && [ "$ASSET_ID" != "null" ]; then
                echo "âœ… $asset ä¸Šä¼ æˆåŠŸ (ID: $ASSET_ID)"
              else
                echo "âŒ $asset ä¸Šä¼ å¤±è´¥"
                echo "$UPLOAD_RESPONSE"
              fi
            else
              echo "âš ï¸ æ–‡ä»¶ $asset ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ "
            fi
          done
          
          echo "=== GitHub Release åˆ›å»ºå®Œæˆ ==="
          echo "Release: $VERSION"
          echo "çŠ¶æ€: $MERGE_STATUS"
